name: Build

on:
  push:
    branches:
    - main
  workflow_dispatch:

jobs:
  configure:
    name: Configure Environments
  
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.json.outputs.matrix }}

    steps:
    - name: Git Checkout
      uses: actions/checkout@v2

    - name: Read JSON
      id: json
      run: |
        echo "::set-output name=matrix::$(jq -c . environments.json)"

  install:
    name: Install ${{ matrix.environment }}

    runs-on: ubuntu-latest

    needs: configure

    strategy:
      matrix:
        include: ${{ fromJson(needs.configure.outputs.matrix) }}
      max-parallel: 2
        
    environment:
      name: ${{ matrix.environment }}

    steps:
    - name: Show Matrix Values
      run: echo "${{ matrix.resourceGroup }}" && echo "${{ matrix.clusterName }}" && echo "${{ secrets.ENVIRONMENT }}"
